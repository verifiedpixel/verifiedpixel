!function(){"use strict";function a(a,b){angular.extend(a,_.pick(b,m))}function b(b,c,d){var e,f="archive_autosave",g=3e3;this.open=function(c){return c._locked?b.when(c):d.find(f,c._id).then(function(b){return a(c,b),c._autosave=b,c},function(){return c})},this.save=function(b,h){return this.stop(),e=c(function(){var c=angular.extend({_id:b._id},h);return d.save(f,{},c).then(function(c){b._autosave=c,a(b._autosave,h),a(b,h)})},g)},this.stop=function(){e&&(c.cancel(e),e=null)},this.drop=function(a){c.cancel(e),d(f).remove(a._autosave),a._autosave=null}}function c(a,b,c,d,e,f){this.open=function(a){return b.find("archive",a,{embedded:{lock_user:1}}).then(function(a){return c.lock(a)}).then(function(a){return d.open(a)}).then(function(a){return e.setActive(a),a})},this.close=function(b,d,g){var h=a.when();return this.isEditable(b)&&(g&&(h=f.confirm().then(angular.bind(this,function(){return this.save(b,d)}),function(){return a.when()})),h=h.then(function(){return c.unlock(b)})),h.then(function(){return e.remove(b)})},this.autosave=function(a,b){return d.save(a,b)},this.save=function(a,c){return d.stop(),b.save("archive",a,c).then(function(){return a._autosave=null,e.update(a),a})},this.isEditable=function(a){return!!a.lock_user&&!c.isLocked(a)},this.unlock=function(a,b){d.stop(),a.lock_user=null,f.unlock(b)}}function d(a,b,c){this.lock=function(d){return d.lock_user?(d._locked=this.isLocked(d),a.when(d)):b("archive_lock",d).save({}).then(function(a){return _.extend(d,a),d._locked=!1,d.lock_user=c.identity._id,d.lock_session=c.sessionId,d},function(){return d._locked=!0,d})},this.unlock=function(a){return b("archive_unlock",a).save({}).then(function(b){return _.extend(a,b),a._locked=!0,a},function(){return a._locked=!0,a})},this.isLocked=function(a){var b=a.lock_user&&a.lock_user._id||a.lock_user;return b?b!==c.identity._id?!0:a.lock_session&&a.lock_session!==c.sessionId?!0:!1:!1},this.isLockedByMe=function(a){return a.lock_user&&a.lock_user===c.identity._id&&a.lock_session!==c.sessionId}}function e(a,b,c,d,e,f){this.setupWindow=function(b){a.onbeforeunload=function(){return b.dirty?f("There are unsaved changes. If you navigate away, your changes will be lost."):void b.$on("$destroy",function(){a.onbeforeunload=angular.noop})}},this.confirm=function(){return e.confirm(f("There are some unsaved changes, do you want to save it now?"),f("Save changes?"),f("Save"),f("Ignore"))},this.unlock=function(a){d.find("users",a).then(function(a){var b=f("This item was unlocked by <b>{{ user }}</b>.").replace("{{ user }}",c("username")(a));return e.confirm(b,f("Item Unlocked"),f("OK"),!1)})}}function f(b,c,d,e,f,g,h,i,j){function k(){function a(){var a=!1;return angular.forEach(b.item,function(b,c){a=a||b!==h[c]}),a}m(),m=b.$watchGroup(["item.headline","item.abstract","item.slugline","item.body_html","item.abstract","item.anpa_take_key","item.unique_name","item.urgency","item.byline","item.priority","item.ednote","item.usageterms","item.subject","item.genre","item['anpa-category']","item.dateline","item.located","item.place","item.language","item.type"],function(){b.dirty=a(),b.dirty&&i.isEditable(h)&&i.autosave(h,b.item)})}var l,m=angular.noop;b.workqueue=d.all(),b.dirty=!1,b.viewSendTo=!1,b.stage=null,b.sluglineSoftLimit=26,b.sluglineHardLimit=40,b.headlineSoftLimit=42,b.headlineHardLimit=70,b.abstractSoftLimit=160,b.abstractHardLimit=200,b.charLimitHit=!1,h.task&&h.task.stage&&j("stages").getById(h.task.stage).then(function(a){b.stage=a}),b.checkLimit=function(){b.charLimitHit=!1,_.each({slugline:b.sluglineSoftLimit,headline:b.headlineSoftLimit,"abstract":b.abstractSoftLimit},function(a,c){return b.item[c]&&b.item[c].length>a?(b.charLimitHit=!0,!1):void 0})},b.save=function(){return m(),i.save(h,b.item).then(function(){return b.dirty=!1,b.item=_.create(h),e.success(f("Item updated.")),k(),h},function(a){e.error(angular.isDefined(a.data._issues)&&angular.isDefined(a.data._issues.unique_name)&&1===a.data._issues.unique_name.unique?f("Error: Unique Name is not unique."):f("Error. Item not updated."))})},b.close=function(){m(),l=!0,i.close(h,b.item,b.dirty).then(function(){c.intent("author","dashboard")})},b.preview=function(c){m(),a(b.item,c),b._editable=!1},b.revert=function(c){return a(b.item,c),b.save()},b.closePreview=function(){b.item=_.create(h),a(b.item,h._autosave||{}),b._editable=i.isEditable(h),b._editable&&k()},b.closePreview(),b.$on("item:unlock",function(a,c){b.item._id!==c.item||l||(m(),i.unlock(h,c.user),b._editable=!1)})}function g(){return{link:function(a,b){var c=b.parent(),d=c.parent().width(),e=parseInt(b.css("margin-left"),10)+parseInt(b.css("margin-right"),10),f=c.outerWidth()+b.outerWidth()+e;d>f&&c.outerWidth(f)}}}function h(){return{scope:{item:"=",limit:"=",limitCallback:"=",html:"@"},template:'<span class="char-count" ng-class="{error: limitHit}">{{numChars}} <span translate>characters</span></span>',link:function(a){a.html=a.html||!1,a.numChars=0,a.limitHit=!1,a.$watch("item",function(){var b=a.item||"";b=a.html?n(b):b,a.numChars=b.length||0,a.limit&&(a.numChars>a.limit&&a.limitHit===!1||a.numChars<=a.limit&&a.limitHit===!0)&&(a.limitHit=!a.limitHit,"function"==typeof a.limitCallback&&a.limitCallback())})}}}function i(){return{scope:{item:"=",html:"@"},template:'<span class="char-count">{{numWords}} <span translate>words</span></span>',link:function(a){a.html=a.html||!1,a.numWords=0,a.$watch("item",function(){var b=a.item||"";b=a.html?n(b):b,a.numWords=_.compact(b.split(/\s+/)).length||0})}}}function j(a){var b={},c="authoring:theme",d="default-normal";return b.availableThemes=[{cssClass:"",label:"Default Theme normal",key:"default-normal"},{cssClass:"large-text",label:"Default Theme large",key:"default-large"},{cssClass:"dark-theme",label:"Dark Theme normal",key:"dark-normal"},{cssClass:"dark-theme large-text",label:"Dark Theme large",key:"dark-large"},{cssClass:"natural-theme",label:"Natural Theme normal",key:"natural-normal"},{cssClass:"natural-theme large-text",label:"Natural Theme large",key:"natural-large"}],b.defaultTheme="default-normal",b.save=function(b){a.setItem(c,b.key)},b.get=function(){var e=a.getItem(c)||d;return _.find(b.availableThemes,{key:e})},b}function k(a){return{templateUrl:"scripts/superdesk-authoring/views/theme-select.html",link:function(b,c){function d(){c.closest("#theme-container").attr("class",b.theme.cssClass)}b.themes=a.availableThemes,b.theme=a.get(),d(),b.changeTheme=function(c){b.theme=c,a.save(c),d()}}}}function l(a,b,c,d,e){return{scope:{item:"=",view:"=",_beforeSend:"=beforeSend"},templateUrl:"scripts/superdesk-authoring/views/send-item.html",link:function(f){function g(a){f.beforeSend().then(function(b){f.task._etag=b._etag,c.save("tasks",f.task,a).then(h)})}function h(){e.success(gettext("Item sent.")),b.intent("author","dashboard")}f.desk=null,f.desks=null,f.stages=null,f.beforeSend=f._beforeSend||a.when;var i=function(){return c.find("tasks",f.item._id).then(function(a){f.task=a}).then(function(){d.initialize().then(function(){f.desks=d.desks,f.item.task&&f.item.task.desk&&(f.desk=d.deskLookup[f.item.task.desk])})})},j=function(){d.initialize().then(function(){f.desks=d.desks,f.item.task&&f.item.task.desk&&(f.desk=d.deskLookup[f.item.task.desk]),f.desk&&(f.stages=d.deskStages[f.desk._id])})};f.$watch("item",function(){i().then(function(){j()})}),f.sendToDesk=function(a){g({task:_.extend(f.task.task,{desk:a._id,stage:a.incoming_stage||null})})},f.sendToStage=function(a){g({task:_.extend(f.task.task,{stage:a._id})})}}}}var m=["headline","slugline","body_html"];b.$inject=["$q","$timeout","api"],c.$inject=["$q","api","lock","autosave","workqueue","confirm"],d.$inject=["$q","api","session"],e.$inject=["$window","$q","$filter","api","modal","gettext"],f.$inject=["$scope","superdesk","workqueue","notify","gettext","desks","item","authoring","api"];var n=function(a){return a.replace(/<\/?[^>]+>/gi,"").replace("&nbsp;"," ")};return h.$inject=[],i.$inject=[],j.$inject=["storage"],k.$inject=["authThemes"],l.$inject=["$q","superdesk","api","desks","notify"],angular.module("superdesk.authoring",["superdesk.editor","superdesk.activity","superdesk.authoring.widgets","superdesk.authoring.metadata","superdesk.authoring.comments","superdesk.authoring.versions","superdesk.authoring.workqueue","superdesk.desks"]).service("authoring",c).service("autosave",b).service("confirm",e).service("lock",d).service("authThemes",j).directive("sdDashboardCard",g).directive("sdSendItem",l).directive("sdCharacterCount",h).directive("sdWordCount",i).directive("sdThemeSelect",k).config(["superdeskProvider",function(a){a.activity("authoring",{when:"/authoring/:_id",label:gettext("Authoring"),templateUrl:"scripts/superdesk-authoring/views/authoring.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",controller:f,filters:[{action:"author",type:"article"}],resolve:{item:["$route","authoring",function(a,b){return b.open(a.current.params._id)}]}}).activity("edit.text",{label:gettext("Edit item"),icon:"pencil",controller:["data","$location","workqueue","superdesk",function(a,b,c,d){c.add(a.item),d.intent("author","article",a.item)}],filters:[{action:"list",type:"archive"}]})}])}(),function(){"use strict";function a(){var a=[];this.widget=function(b,c){a.push(angular.extend({},c,{_id:b}))},this.$get=function(){return a}}function b(a,b,c){a.active=null,a.widgets=c,a.activate=function(b){a.active=a.active===b?null:b},angular.forEach(a.widgets,function(c){b[c._id]&&a.activate(c)})}function c(){return{controller:b,templateUrl:"scripts/superdesk-authoring/widgets/views/authoring-widgets.html",transclude:!0}}b.$inject=["$scope","$routeParams","authoringWidgets"],angular.module("superdesk.authoring.widgets",[]).provider("authoringWidgets",a).directive("sdAuthoringWidgets",c)}(),function(){"use strict";function a(a){this.comments=null,this.fetch=function(b){var c={where:{item:b},embedded:{user:1}};return a.item_comments.query(c).then(angular.bind(this,function(a){this.comments=a._items}))},this.save=function(b){return a.item_comments.save(b)}}function b(a,b,c){function e(){a.item&&c.fetch(a.item._id).then(function(){a.comments=c.comments})}function f(){a.active=b.comments||null}a.text=null,a.saveEnterFlag=!1,a.$watch("item._id",e),a.users=[],a.saveOnEnter=function(b){a.saveEnterFlag&&b.keyCode===d&&!b.shiftKey&&a.save()},a.save=function(){var b=a.text||"";b.length&&(a.text="",a.flags={saving:!0},c.save({text:b,item:a.item._id}).then(e))},a.cancel=function(){a.text=""},a.$on("item:comment",function(b,c){c.item===a.item.guid&&e()}),a.$on("$locationChangeSuccess",f),f()}function c(a){return{scope:{comment:"="},link:function(b,c,d){var e;e=d.text.replace(/(?:\r\n|\r|\n)/g,"</p><p>");var f=e.match(/\@([a-zA-Z0-9-_.]\w+)/g);_.each(f,function(a){var c=a.substring(1,a.length);b.comment.mentioned_users&&b.comment.mentioned_users[c]&&(e=e.replace(a,'<i sd-user-info data-user="'+b.comment.mentioned_users[c]+'">'+a+"</i>"))}),c.html("<p><b>"+d.name+"</b> : "+e+"</p>"),a(c.contents())(b)}}}var d=13;a.$inject=["api"],b.$inject=["$scope","$routeParams","commentsService","api","$q"],c.$inject=["$compile"],angular.module("superdesk.authoring.comments",["superdesk.authoring.widgets","mentio","superdesk.api"]).config(["authoringWidgetsProvider",function(a){a.widget("comments",{icon:"comments",label:gettext("Comments"),template:"scripts/superdesk-authoring/comments/views/comments-widget.html"})}]).config(["apiProvider",function(a){a.api("item_comments",{type:"http",backend:{rel:"item_comments"}})}]).controller("CommentsWidgetCtrl",b).service("commentsService",a).directive("sdCommentText",c)}(),function(){"use strict";function a(a,b,c){function d(b){c.users.getById(b).then(function(c){a.users[b]=c})}function e(){return a.canRevert=b.isEditable(a.item),c.archive.getByUrl(a.item._links.self.href+'?version=all&embedded={"user":1}').then(function(b){_.each(b._items,function(b){var c=b.creator||b.original_creator;c&&!a.users[c]&&d(c)}),a.versions=b,a.selected=a.item._autosave?a.item._autosave:f(),a.last=f()})}function f(){return a.item._latest_version?_.find(a.versions._items,{_version:a.item._latest_version}):_.max(a.versions._items,function(a){return a._version||a.version||a._updated})}a.last=null,a.versions=null,a.selected=null,a.users={},a.canRevert=!1,a.openAutosave=function(){a.selected=a.item._autosave,a.closePreview()},a.openVersion=function(b){a.selected=b,b!==a.last||a.item._autosave?a.preview(b):a.closePreview()},a.revert=function(b){a.$parent.revert(b).then(e)},a.$watchGroup(["item._id","item._latest_version"],e)}a.$inject=["$scope","authoring","api","$location","notify","workqueue","lock"],angular.module("superdesk.authoring.versions",[]).config(["authoringWidgetsProvider",function(a){a.widget("versions",{icon:"revision",label:gettext("Versions"),template:"scripts/superdesk-authoring/versioning/views/versions.html"})}]).controller("VersioningWidgetCtrl",a)}(),function(){"use strict";function a(a,b,c){b.initialize().then(function(){a.deskLookup=b.deskLookup,a.userLookup=b.userLookup}),c.initialize().then(function(){a.metadata=c.values}),a.texttypes=["text","preformatted"],a.processGenre=function(){a.item.genre=_.map(a.item.genre,function(a){return _.pick(a,"name")})}}function b(){return{scope:{list:"=",disabled:"=",item:"=",field:"@"},templateUrl:"scripts/superdesk-authoring/metadata/views/metadata-dropdown.html",link:function(a){a.select=function(b){a.item=a.field?b[a.field]:b}}}}function c(){return{scope:{item:"=",field:"@",disabled:"=",list:"=",unique:"@",postprocessing:"&"},templateUrl:"scripts/superdesk-authoring/metadata/views/metadata-terms.html",link:function(a){a.terms=[],a.selectedTerm="";var b=a.unique||"qcode";a.searchTerms=function(c){return a.terms=c?_.filter(a.list,function(d){var e={};return e[b]=d[b],-1!==d.name.toLowerCase().indexOf(c.toLowerCase())&&!_.find(a.item[a.field],e)}):[],a.terms},a.selectTerm=function(b){if(b){var c=_.clone(a.item[a.field])||[];c.push(b);var d={};d[a.field]=c,_.extend(a.item,d),a.selectedTerm="",a.postprocessing()}},a.removeTerm=function(b){var c=_.without(a.item[a.field],b),d={};d[a.field]=c,_.extend(a.item,d)}}}}function d(a,b,c){var d={values:{},loaded:null,fetchMetadataValues:function(){var b=this;return a("vocabularies").query().then(function(a){_.each(a._items,function(a){b.values[a._id]=a.items})})},fetchStaticMetadata:function(){var a=this;return _.each(c,function(b){a.values[b._id]=b.items}),b.when()},fetchSubjectcodes:function(){var b=this;return a.get("/subjectcodes").then(function(a){b.values.subjectcodes=a._items})},initialize:function(){return this.loaded||(this.loaded=this.fetchMetadataValues().then(angular.bind(this,this.fetchStaticMetadata)).then(angular.bind(this,this.fetchSubjectcodes))),this.loaded}};return d}a.$inject=["$scope","desks","metadata","$filter"],b.$inject=[],c.$inject=[],d.$inject=["api","$q","staticMetadata"];var e=[{_id:"priority",items:[{name:"B",qcode:"B"},{name:"D",qcode:"D"},{name:"F",qcode:"F"},{name:"R",qcode:"R"},{name:"U",qcode:"U"},{name:"Z",qcode:"Z"}]}];angular.module("superdesk.authoring.metadata",["superdesk.authoring.widgets"]).config(["authoringWidgetsProvider",function(a){a.widget("metadata",{icon:"info",label:gettext("Info"),template:"scripts/superdesk-authoring/metadata/views/metadata-widget.html",order:1})}]).controller("MetadataWidgetCtrl",a).service("metadata",d).directive("sdMetaTerms",c).directive("sdMetaDropdown",b).value("staticMetadata",e)}(),function(){"use strict";function a(a,b,c){var d=[];b.get("workqueue:items").then(function(a){d=a.items}),this.length=0,this.active=null,this.add=function(a){return _.remove(d,{_id:a._id}),d.unshift(a),this.length=d.length,this.active=a,this.save(),this},this.update=function(a){if(a){var b=this.find({_id:a._id});d[_.indexOf(d,b)]=_.extend(b,a),this.save()}},this.first=function(){return _.first(d)},this.all=function(){return d},this.save=function(){var a={"workqueue:items":{items:d}};b.update(a,"workqueue:items").then(function(){},function(){c.error(gettext("User preference could not be saved..."))})},this.find=function(a){return _.find(d,a)},this.setActive=function(a){this.active=a?this.find({_id:a._id}):null},this.getActive=function(){return this.active?this.active._id:null},this.remove=function(a){_.remove(d,{_id:a._id}),this.length=d.length,this.save(),this.active=null}}function b(a,b){a.content=new b}function c(a,b){return{templateUrl:"scripts/superdesk-authoring/views/opened-articles.html",scope:{active:"=",update:"&",close:"&"},link:function(c){c.workqueue=a.all(),c.openItem=function(d){c.active&&c.update(),a.setActive(d),b.intent("author","article",d)},c.openDashboard=function(){b.intent("author","dashboard")},c.closeItem=function(b){c.active&&c.active._id===b._id?c.close():a.remove(b)}}}}a.$inject=["storage","preferencesService","notify"],b.$inject=["$scope","ContentCtrl"],c.$inject=["workqueue","superdesk"],angular.module("superdesk.authoring.workqueue",["superdesk.activity"]).service("workqueue",a).directive("sdWorkqueue",c).config(["superdeskProvider",function(a){a.activity("/authoring/",{label:gettext("Authoring"),templateUrl:"scripts/superdesk-authoring/views/dashboard.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",beta:!0,controller:b,category:a.MENU_MAIN,filters:[{action:"author",type:"dashboard"}]})}])}(),function(){"use strict";function a(a,b){function c(){var b=(a.search().sort||"versioncreated:desc").split(":");return angular.extend(_.find(h,{field:b[0]}),{dir:b[1]})}function d(a){var b=_.find(h,{field:a});f(b.field,b.defaultDir||"desc")}function e(){var a=c(),b="asc"===a.dir?"desc":"asc";f(a.field,b)}function f(b,c){a.search("sort",b+":"+c),a.search("page",null)}function g(){function b(a,b){var c=b.page||1,d=e||Number(localStorage.getItem("pagesize"))||Number(b.max_results)||f;a.size=d,a.from=(c-1)*a.size}function d(a,b){if(a.beforefirstcreated||a.afterfirstcreated){var c={firstcreated:{}};a.beforefirstcreated&&(c.firstcreated.lte=a.beforefirstcreated),a.afterfirstcreated&&(c.firstcreated.gte=a.afterfirstcreated),b.filter({range:c})}if(a.beforeversioncreated||a.afterversioncreated){var d={versioncreated:{}};a.beforeversioncreated&&(d.versioncreated.lte=a.beforeversioncreated),a.afterversioncreated&&(d.versioncreated.gte=a.afterversioncreated),b.filter({range:d})}if(a.after){var e={firstcreated:{}};e.firstcreated.gte=a.after,b.filter({range:e})}if(a.type){var f={type:JSON.parse(a.type)};b.filter({terms:f})}a.urgency&&b.filter({term:{urgency:JSON.parse(a.urgency)}}),a.source&&b.filter({term:{source:JSON.parse(a.source)}}),a.category&&b.filter({term:{"anpa-category.name":JSON.parse(a.category)}}),a.desk&&b.filter({term:{"task.desk":JSON.parse(a.desk)}}),a.stage&&b.filter({term:{"task.stage":JSON.parse(a.stage)}})}var e,f=25,g=[];this.getCriteria=function(d){var e=a.search(),f=c(),h={query:{filtered:{filter:{and:g}}},sort:[_.zipObject([f.field],[f.dir])]};return b(h,e),e.q&&(h.query.filtered.query={query_string:{query:e.q,lenient:!1,default_operator:"AND"}}),d&&(h={source:h},e.repo&&(h.repo=e.repo)),h},this.filter=function(a){return g.push(a),this},this.size=function(a){return e=null!=a?a:e,this},this.filter(a.search().spike?{term:{is_spiked:!0}}:{not:{term:{is_spiked:!0}}}),d(a.search(),this)}var h=[{field:"versioncreated",label:b("Updated")},{field:"firstcreated",label:b("Created")},{field:"urgency",label:b("News Value")},{field:"anpa-category.name",label:b("Category")},{field:"slugline",label:b("Keyword")},{field:"priority",label:b("Priority")}];this.setSort=d,this.getSort=c,this.sortOptions=h,this.toggleSortDir=e,this.query=function(a){return new g(a)}}function b(a,b,c,d){function e(){var b=d.query().getCriteria(!0);c.query("search",b).then(function(b){a.items=b})}a.context="search",a.repo={ingest:!0,archive:!0},a.$watch(function(){return _.omit(b.search(),"_id")},e,!0)}a.$inject=["$location","gettext"],b.$inject=["$scope","$location","api","search"],angular.module("superdesk.search",["superdesk.api","superdesk.activity","superdesk.desks"]).service("search",a).directive("sdSearchFacets",["$location","desks",function(a,b){return b.initialize(),{require:"^sdSearchContainer",templateUrl:"scripts/superdesk-search/views/search-facets.html",scope:{items:"=",desk:"="},link:function(c,d,e,f){c.flags=f.flags,c.sTab=!0,c.aggregations={},c.selectedFacets={},c.keyword=null;var g=function(){c.aggregations={type:{},desk:{},stage:{},date:{},source:{},category:{},urgency:{},spiked:{}}},h={_id:1,q:1,repo:1,page:1,beforeversioncreated:1,afterversioncreated:1,beforefirstcreated:1,afterfirstcreated:1,after:1},i=function(){b.initialize().then(function(){var d=a.search();c.keyword=d.q,_.forEach(d,function(a,d){if("desk"===d)c.selectedFacets[d]=b.deskLookup[JSON.parse(a)[0]].name;else if("stage"===d){var e=a;_.forEach(b.deskStages[b.activeDeskId],function(a){a._id===JSON.parse(e)[0]&&(c.selectedFacets[d]=a.name)})}else h[d]||(c.selectedFacets[d]=JSON.parse(a)[0])})})};c.$watch("items",function(){g(),i();var d=a.search();d.q&&c.keyword!==d.q&&(c.selectedFacets={},c.keyword=d.q),c.items&&void 0!==c.items._aggregations&&(_.forEach(c.items._aggregations.type.buckets,function(a){c.selectedFacets.type&&c.selectedFacets.type===a.key||(c.aggregations.type[a.key]=a.doc_count)}),_.forEach(c.items._aggregations.category.buckets,function(a){c.selectedFacets.category&&c.selectedFacets.category===a.key||""===a.key||(c.aggregations.category[a.key]=a.doc_count)}),_.forEach(c.items._aggregations.urgency.buckets,function(a){c.selectedFacets.urgency&&c.selectedFacets.urgency===a.key||(c.aggregations.urgency[a.key]=a.doc_count)}),_.forEach(c.items._aggregations.source.buckets,function(a){c.selectedFacets.source&&c.selectedFacets.source===a.key||(c.aggregations.source[a.key]=a.doc_count)}),_.forEach(c.items._aggregations.day.buckets,function(a){c.selectedFacets.date&&"Last Day"===c.selectedFacets.date||a.doc_count>0&&(c.aggregations.date["Last Day"]=a.doc_count)}),_.forEach(c.items._aggregations.week.buckets,function(a){c.selectedFacets.date&&"Last Week"===c.selectedFacets.date||a.doc_count>0&&(c.aggregations.date["Last Week"]=a.doc_count)}),_.forEach(c.items._aggregations.month.buckets,function(a){c.selectedFacets.date&&"Last Month"===c.selectedFacets.date||a.doc_count>0&&(c.aggregations.date["Last Month"]=a.doc_count)}),b.initialize().then(function(){c.desk||_.forEach(c.items._aggregations.desk.buckets,function(a){c.selectedFacets.desk&&c.selectedFacets.desk===b.deskLookup[a.key].name||(c.aggregations.desk[b.deskLookup[a.key].name]={count:a.doc_count,id:a.key})}),c.desk&&_.forEach(c.items._aggregations.stage.buckets,function(a){_.forEach(b.deskStages[c.desk._id],function(b){c.selectedFacets.stage&&c.selectedFacets.stage===b.name||b._id===a.key&&(c.aggregations.stage[b.name]={count:a.doc_count,id:a.key})})})}))});var j=function(a,d){"desk"===a?c.selectedFacets[a]=b.deskLookup[d].name:"stage"===a?_.forEach(b.deskStages[b.activeDeskId],function(b){b._id===d&&(c.selectedFacets[a]=b.name)}):c.selectedFacets[a]=d};c.setFilter=function(b,d){j(b,d),!c.isEmpty(b)&&d?a.search(b,JSON.stringify([d])):a.search(b,null)},c.setDateFilter=function(b){c.selectedFacets.date=b,"Last Day"===b?a.search("after","now-24H"):"Last Week"===b?a.search("after","now-1w"):"Last Month"===b?a.search("after","now-1M"):a.search("after",null)},c.removeFilter=function(b,d){if(d.indexOf("Last")>=0)c.removeDateFilter(d);else{var e=a.search();if(e[b]){var f=JSON.parse(e[b]);f.splice(f.indexOf(d),1),f.length>0?a.search(b,JSON.stringify(f)):a.search(b,null)}delete c.selectedFacets[b]}},c.removeDateFilter=function(){var b=a.search();b.after&&a.search("after",null),delete c.selectedFacets.date},c.isEmpty=function(a){return _.isEmpty(c.aggregations[a])},c.format=function(a){return a?moment(a).format("YYYY-MM-DD"):null}}}}]).directive("sdSearchResults",["$location","preferencesService",function(a,b){var c={"archive:view":{allowed:["mgrid","compact"],category:"archive",view:"mgrid","default":"mgrid",label:"Users archive view format",type:"string"}};return{require:"^sdSearchContainer",templateUrl:"scripts/superdesk-search/views/search-results.html",link:function(d,e,f,g){d.flags=g.flags,d.selected=d.selected||{},d.preview=function(b){d.selected.preview=b,a.search("_id",b?b._id:null)},d.openLightbox=function(){d.selected.view=d.selected.preview},d.closeLightbox=function(){d.selected.view=null},d.setview=function(a){c["archive:view"].view=a||"mgrid",b.update(c,"archive:view").then(function(){d.view=a||"mgrid"})};var h;b.get("archive:view").then(function(a){h=a.view,d.view=h&&"undefined"!==h?h:"mgrid"})}}}]).directive("sdSearchWithin",["$location",function(a){return{scope:{},templateUrl:"scripts/superdesk-search/views/search-within.html",link:function(b){b.searchWithin=function(){if(b.within){var c=a.search();b.query=c.q?c.q+" "+b.within:b.within,a.search("q",b.query||null),b.within=null}}}}}]).directive("sdItemSearchbar",["$location",function(a){return{scope:{repo:"=",context:"="},templateUrl:"scripts/superdesk-search/views/item-searchbar.html",link:function(b,c){function d(){var c=a.search();b.query=c.q,b.flags=!1,b.meta={},c.repo&&(b.repo.archive=c.repo.indexOf("archive")>=0,b.repo.ingest=c.repo.indexOf("ingest")>=0)}function e(){var a=[];return angular.forEach(b.repo,function(b,c){b&&a.push(c)}),a.length?a.join(","):null}function f(a){for(var b in a)if(a.hasOwnProperty(b))return b}function g(){var a=[];return angular.forEach(b.meta,function(b,c){if("_all"===c)a.push(b.join(" "));else if(b)if("string"==typeof b)b&&a.push(c+":("+b+")");else{var d=f(b);b[d]&&a.push(c+"."+d+":("+b[d]+")")}}),a.length?a.join(" "):b.query||null}function h(){a.$$search={},a.search("q",g()||null),a.search("repo",e()),b.query=a.search().q,b.meta={}}function i(){b.meta={},b.query&&angular.forEach(b.query.split(" "),function(a){if(a.indexOf(":")>=0){var c=a.split(":")[0],d=a.split(":")[1].replace("(","").replace(")","");if(c.indexOf(".")>=0){var e=c.split(".")[0],f=c.split(".")[1];b.meta[e]={},b.meta[e][f]=d}else b.meta[c]=d}else b.meta._all||(b.meta._all=[]),b.meta._all.push(a)})}function j(){b.flags.extended=!1}var k=13,l=27,m=c.find("#search-input");b.advancedOpen=!1,d(),b.$on("$locationChangeSuccess",function(){b.query!==a.search().q&&d()}),b.search=function(){h(),j()},b.searchOnEnter=function(a){a.keyCode===k&&(b.search(),a.stopPropagation()),a.keyCode===l&&j()},b.focusOnSearch=function(){b.advancedOpen&&b.toggle(),m.focus()},b.toggle=function(){b.advancedOpen=!b.advancedOpen,b.advancedOpen&&i()}}}}]).directive("sdItemSortbar",["$location","search",function(a,b){return{scope:{},templateUrl:"scripts/superdesk-search/views/item-sortbar.html",link:function(a){function c(){a.active=b.getSort()}a.sortOptions=b.sortOptions,a.sort=function(a){b.setSort(a)},a.toggleDir=function(){b.toggleSortDir()},a.$on("$routeUpdate",c),c()}}}]).directive("sdSearchContainer",function(){return{controller:["$scope",function(a){this.flags=a.flags||{}}]}}).config(["superdeskProvider",function(a){a.activity("/search",{beta:1,priority:200,category:a.MENU_MAIN,label:gettext("Search"),controller:b,templateUrl:"scripts/superdesk-search/views/search.html"})}])}(),function(){"use strict";var a=angular.module("superdesk.stream",["superdesk.activity","superdesk.asset"]);a.controller("StreamController",["$scope","api","$rootScope","desks",function(a,b,c){a.desk=null,a.activities=null,a.pageLength=10,a.max_results=a.pageLength,a.loadMore=function(){a.activities._meta.total>a.max_results&&(a.max_results+=a.pageLength,d())},a.showDateHeader=function(b){if(a.currentDate=new Date(a.activities._items[b.index]._created),0===b.index)return!0;var c=new Date(a.activities._items[b.index-1]._created);return c.getYear()!==a.currentDate.getYear()||c.getMonth()!==a.currentDate.getMonth()||c.getDate()!==a.currentDate.getDate()};var d=function(){var c={embedded:{user:1},max_results:a.max_results};a.desk&&(c.where={desk:a.desk._id}),b("activity").query(c).then(function(b){b._items.forEach(function(a,b){a.display_message=a.message;for(var c in a.data)if(a.data.hasOwnProperty(c)){var d=new RegExp("{{\\s*"+c+"\\s*}}","gi");a.display_message=a.display_message.replace(d,a.data[c]),a.index=b}}),a.activities=b})};a.$watch("desk",function(){d()}),c.$on("activity",function(){d()})}]).config(["superdeskProvider","assetProvider","gettext",function(a,b,c){a.activity("/workspace/stream",{label:c("Workspace"),controller:"StreamController",templateUrl:b.templateUrl("superdesk-stream/views/workspace-stream.html"),topTemplateUrl:b.templateUrl("superdesk-dashboard/views/workspace-topnav.html"),beta:!0})}])}();